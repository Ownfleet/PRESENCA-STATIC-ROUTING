<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Cheguei no HUB</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  :root{
    --bg:#070a14;
    --card: rgba(255,255,255,.07);
    --stroke: rgba(255,255,255,.12);
    --text:#e8ecff;
    --muted: rgba(232,236,255,.75);
    --brand:#ff5a2a;
    --brand2:#ff8a2a;
    --ok:#22c55e;
    --bad:#ef4444;
    --warn:#f59e0b;
    --r:18px;
    --sh: 0 16px 40px rgba(0,0,0,.45);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    color:var(--text);
    background:
      radial-gradient(1100px 600px at 20% -10%, rgba(255,90,42,.33), transparent 60%),
      radial-gradient(900px 520px at 110% 0%, rgba(255,138,42,.22), transparent 58%),
      linear-gradient(180deg, #060814, #0b1228);
    overflow:hidden;
  }

  .app{
    height:100vh;
    display:grid;
    grid-template-rows: auto auto 1fr auto;
    gap:10px;
    padding: env(safe-area-inset-top) 12px env(safe-area-inset-bottom) 12px;
  }

  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:12px 4px 0;
  }

  .hleft{display:flex; gap:10px; align-items:center;}
  .logo{
    width:42px;height:42px;border-radius:14px;
    background: linear-gradient(135deg, var(--brand), var(--brand2));
    box-shadow: 0 14px 38px rgba(255,90,42,.28);
  }
  .ttl h1{margin:0;font-size:16px;letter-spacing:.2px}
  .ttl p{margin:3px 0 0;font-size:12px;color:var(--muted)}

  .status{
    display:flex; align-items:center; gap:8px;
    padding:10px 12px;
    border-radius:999px;
    background: rgba(255,255,255,.06);
    border:1px solid var(--stroke);
    box-shadow: 0 10px 26px rgba(0,0,0,.22);
    min-width: 140px;
    justify-content:center;
  }
  .dot{
    width:10px;height:10px;border-radius:99px;
    background: var(--warn);
    box-shadow: 0 0 0 6px rgba(245,158,11,.14);
  }
  .stxt{font-size:12.5px;font-weight:800}
  .smini{font-size:11px;color:var(--muted)}

  .card{
    background: var(--card);
    border:1px solid var(--stroke);
    border-radius: var(--r);
    box-shadow: var(--sh);
    overflow:hidden;
  }

  .topbar{
    padding:12px;
    display:grid;
    grid-template-columns: 1fr auto auto;
    gap:10px;
    align-items:center;
  }

  .field{
    position:relative;
    border-radius: 16px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    overflow:hidden;
  }
  .field input{
    width:100%;
    padding:14px 14px 14px 14px;
    font-size:16px;
    border:0; outline:0;
    background: transparent;
    color:var(--text);
  }
  .field input::placeholder{color: rgba(232,236,255,.55)}

  .btn{
    border:0;
    border-radius:16px;
    padding:12px 12px;
    color:var(--text);
    background: rgba(255,255,255,.07);
    border:1px solid rgba(255,255,255,.12);
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:8px;
    user-select:none;
    white-space:nowrap;
  }
  .btn:active{ transform:scale(.985); }
  .btn[disabled]{opacity:.6; cursor:not-allowed;}

  .gridInfo{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:8px;
    padding: 0 12px 12px;
  }
  .info{
    padding:10px 10px;
    border-radius:16px;
    background: rgba(11,18,40,.55);
    border:1px solid rgba(255,255,255,.10);
  }
  .k{font-size:11px;color:var(--muted)}
  .v{font-size:13px;font-weight:900;margin-top:2px}

  .mapWrap{
    position:relative;
    height: 100%;
    min-height: 44vh;
  }
  #map{ height:100%; width:100%; }

  .hud{
    position:absolute;
    left:10px; right:10px; top:10px;
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    pointer-events:none;
  }
  .chip{
    pointer-events:none;
    padding:9px 10px;
    border-radius: 14px;
    background: rgba(11,18,40,.65);
    border:1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(10px);
    font-size:12px;
    box-shadow: 0 10px 26px rgba(0,0,0,.30);
  }

  .footer{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
    padding: 0 4px 10px;
  }
  .cta{
    width:100%;
    padding:16px 14px;
    font-size:18px;
    font-weight:950;
    letter-spacing:.4px;
    border:0;
    border-radius: 20px;
    color:white;
    background: linear-gradient(135deg, var(--brand), var(--brand2));
    box-shadow: 0 18px 44px rgba(255,90,42,.28);
    cursor:pointer;
  }
  .cta:active{ transform:scale(.985); }
  .cta[disabled]{opacity:.6; cursor:not-allowed;}
  .loader{
    width:18px;height:18px;border-radius:99px;
    border:2px solid rgba(255,255,255,.35);
    border-top-color: rgba(255,255,255,1);
    display:inline-block;
    margin-left:10px;
    vertical-align:middle;
    animation: rot .8s linear infinite;
  }
  @keyframes rot{to{transform:rotate(360deg)}}

  .log{
    padding:12px;
    border-radius: var(--r);
    background: rgba(0,0,0,.30);
    border:1px solid rgba(255,255,255,.10);
    color: rgba(232,236,255,.88);
    font-size:12.5px;
    line-height:1.35;
    white-space:pre-wrap;
    max-height: 160px;
    overflow:auto;
  }

  /* Ajuste para telas muito pequenas */
  @media (max-width: 360px){
    .gridInfo{grid-template-columns: 1fr 1fr;}
    .status{min-width: 110px;}
  }

  .leaflet-control-zoom a{
    background: rgba(11,18,40,.82) !important;
    color: #fff !important;
    border: 1px solid rgba(255,255,255,.12) !important;
  }
  .leaflet-control-attribution{
    background: rgba(11,18,40,.62) !important;
    color: rgba(232,236,255,.75) !important;
    border-radius: 12px;
    padding: 4px 8px !important;
    border: 1px solid rgba(255,255,255,.10);
  }
</style>
</head>

<body>
<div class="app">

  <header>
    <div class="hleft">
      <div class="logo"></div>
      <div class="ttl">
        <h1>Check-in HUB</h1>
        <p>Mapa + raio + diagnóstico</p>
      </div>
    </div>

    <div class="status">
      <span class="dot" id="dot"></span>
      <div>
        <div class="stxt" id="stxt">Calibrando...</div>
        <div class="smini" id="smini">Aguardando GPS</div>
      </div>
    </div>
  </header>

  <div class="card">
    <div class="topbar">
      <div class="field"><input id="driverId" placeholder="Digite seu ID" inputmode="numeric" autocomplete="off"></div>
      <button class="btn" id="btnRecal" onclick="recalibrar()">Recalibrar</button>
      <button class="btn" onclick="testarWebApp()">Testar WebApp</button>
    </div>

    <div class="gridInfo">
      <div class="info"><div class="k">Distância</div><div class="v" id="dist">-- m</div></div>
      <div class="info"><div class="k">Raio</div><div class="v" id="raio">-- m</div></div>
      <div class="info"><div class="k">Precisão (acc)</div><div class="v" id="acc">-- m</div></div>
    </div>
  </div>

  <div class="card mapWrap">
    <div class="hud">
      <div class="chip" id="chip1">URL: --</div>
      <div class="chip" id="chip2">Último envio: --</div>
    </div>
    <div id="map"></div>
  </div>

  <div class="footer">
    <button class="cta" id="btnSend" onclick="checkIn()">CHEGUEI NO HUB<span id="ld" style="display:none" class="loader"></span></button>
    <div class="log" id="log">LOG: iniciando…</div>
  </div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/*** CONFIG ***/
const HUB_LAT = -23.443825;
const HUB_LNG = -46.529107;
const RAIO_METROS = 200;

const MIN_ACCURACY = 120;     // se o GPS vier pior que isso, pede recalibrar
const AMOSTRAS = 5;
const INTERVALO_MS = 650;

const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyd5RFCJjpjfUd-wylkdslI9zHSx08SbuUgUViMyX4Ykwv0Jlp3UMwLeqQ72_182lvm/exec";

/*** UI helpers ***/
const el = id => document.getElementById(id);
function setStatus(type, title, sub){
  const dot = el("dot");
  const map = {
    ok: ["var(--ok)", "rgba(34,197,94,.14)"],
    bad:["var(--bad)","rgba(239,68,68,.14)"],
    warn:["var(--warn)","rgba(245,158,11,.14)"]
  };
  const [c, glow] = map[type] || map.warn;
  dot.style.background = c;
  dot.style.boxShadow = `0 0 0 6px ${glow}`;
  el("stxt").innerText = title;
  el("smini").innerText = sub || "";
}
function logAdd(t){
  const box = el("log");
  box.textContent = `${new Date().toLocaleTimeString()} — ${t}\n` + box.textContent;
}
el("raio").innerText = `${RAIO_METROS} m`;
el("chip1").innerText = "URL: " + WEBAPP_URL.slice(0, 42) + "…";

/*** distance ***/
function distanciaMetros(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = x => x*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

/*** Map ***/
const map = L.map('map').setView([HUB_LAT, HUB_LNG], 17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20, attribution: '&copy; OpenStreetMap' }).addTo(map);

const hubMarker = L.marker([HUB_LAT, HUB_LNG]).addTo(map).bindPopup("HUB");
const hubCircle = L.circle([HUB_LAT, HUB_LNG], { radius: RAIO_METROS }).addTo(map);

let driverMarker = null;
let lineToHub = null;
let lastBest = null;

function updateMap(lat, lng){
  if(!driverMarker) driverMarker = L.marker([lat,lng]).addTo(map).bindPopup("Você");
  else driverMarker.setLatLng([lat,lng]);

  if(lineToHub) map.removeLayer(lineToHub);
  lineToHub = L.polyline([[lat,lng],[HUB_LAT,HUB_LNG]]).addTo(map);

  const group = L.featureGroup([hubMarker, hubCircle, driverMarker, lineToHub]);
  map.fitBounds(group.getBounds().pad(0.18));
}

/*** Strong GPS sampling ***/
function obterLocalizacaoReforcada(){
  return new Promise((resolve, reject) => {
    if(!navigator.geolocation) return reject("Sem suporte a GPS no navegador.");

    let tent = 0;
    let best = null;

    const step = () => {
      navigator.geolocation.getCurrentPosition(
        pos => {
          tent++;
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const acc = Number(pos.coords.accuracy || 9999);

          if(!best || acc < best.acc) best = {lat, lng, acc};

          const dist = distanciaMetros(best.lat, best.lng, HUB_LAT, HUB_LNG);
          lastBest = {...best, dist};

          el("dist").innerText = `${Math.round(dist)} m`;
          el("acc").innerText = `${Math.round(best.acc)} m`;
          updateMap(best.lat, best.lng);

          setStatus("warn", "Calibrando…", `leitura ${tent}/${AMOSTRAS} • melhor ~${Math.round(best.acc)}m`);
          logAdd(`GPS leitura ${tent}/${AMOSTRAS} | acc=${Math.round(acc)}m | best=${Math.round(best.acc)}m | distBest=${Math.round(dist)}m`);

          if(tent >= AMOSTRAS){
            if(best.acc > MIN_ACCURACY){
              setStatus("bad", "Precisão fraca", `~${Math.round(best.acc)}m (mín ${MIN_ACCURACY}m)`);
              return reject(`Precisão fraca (~${Math.round(best.acc)}m). Vá para um local aberto e recalibre.`);
            }

            if(dist <= RAIO_METROS){
              setStatus("ok", "Dentro do raio", `dist ~${Math.round(dist)}m | raio ${RAIO_METROS}m`);
            }else{
              setStatus("bad", "Fora do raio", `dist ~${Math.round(dist)}m | raio ${RAIO_METROS}m`);
            }
            return resolve(lastBest);
          }

          setTimeout(step, INTERVALO_MS);
        },
        err => reject("Permita o GPS e ative localização (alta precisão)."),
        { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
      );
    };

    step();
  });
}

async function recalibrar(){
  try{
    el("btnRecal").disabled = true;
    logAdd("Recalibrando…");
    await obterLocalizacaoReforcada();
  }catch(e){
    logAdd("ERRO GPS: " + e);
  }finally{
    el("btnRecal").disabled = false;
  }
}

/*** Debug: test webapp with GET ***/
async function testarWebApp(){
  try{
    logAdd("Testando WebApp (GET)...");
    const r = await fetch(WEBAPP_URL, { method:"GET" });
    const t = await r.text();
    logAdd(`GET status=${r.status} | resposta=${t.slice(0,120)}`);
    el("chip2").innerText = "Último envio: TESTE GET OK";
  }catch(e){
    logAdd("FALHA GET: " + e);
    el("chip2").innerText = "Último envio: TESTE GET FALHOU";
  }
}

/*** Send with timeout + show response ***/
async function checkIn(){
  const id = el("driverId").value.trim();
  if(!id){ logAdd("ID vazio."); return; }

  const btn = el("btnSend");
  const ld  = el("ld");

  btn.disabled = true;
  ld.style.display = "inline-block";

  try{
    logAdd("Preparando envio…");
    const best = await obterLocalizacaoReforcada();

    if(best.dist > RAIO_METROS){
      logAdd(`BLOQUEADO: fora do raio (dist=${Math.round(best.dist)}m)`);
      setStatus("bad","Fora do raio",`dist ~${Math.round(best.dist)}m`);
      return;
    }

    const payload = { id, lat: best.lat, lng: best.lng, acc: best.acc };
    logAdd("Payload: " + JSON.stringify(payload));

    // timeout 20s
    const controller = new AbortController();
    const to = setTimeout(() => controller.abort(), 20000);

    logAdd("Enviando POST…");
    const r = await fetch(WEBAPP_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload),
      signal: controller.signal
    });

    clearTimeout(to);

    const text = await r.text();
    logAdd(`POST status=${r.status}`);
    logAdd("Resposta: " + text);

    el("chip2").innerText = "Último envio: " + new Date().toLocaleTimeString();

    // Heurística: se vier HTML de login, você vai ver no log
    if(text.includes("<html") || text.toLowerCase().includes("sign in")){
      setStatus("bad","WebApp bloqueado","parece pedir login/permissão");
      logAdd("⚠️ Parece que o WebApp retornou HTML (login/permissão). Verifique implantação: 'Qualquer pessoa'.");
    }else{
      setStatus("ok","Enviado","verifique a planilha");
    }

  }catch(e){
    logAdd("ERRO ENVIO: " + e);
    setStatus("bad","Falha no envio", String(e).slice(0,40));
  }finally{
    btn.disabled = false;
    ld.style.display = "none";
  }
}

/*** init ***/
logAdd("Iniciado.");
recalibrar();
</script>

</body>
</html>
