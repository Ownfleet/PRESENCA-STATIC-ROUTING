<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Cheguei no HUB</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  body{
    margin:0;
    font-family: Arial, sans-serif;
    background:#0f172a;
    color:#fff;
  }
  .wrap{
    display:flex;
    flex-direction:column;
    height:100vh;
  }
  header{
    padding:14px 16px;
    font-size:18px;
    font-weight:bold;
    background:#111b36;
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .panel{
    padding:14px 16px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    background:#0f172a;
  }
  input{
    flex:1;
    min-width:180px;
    padding:14px;
    font-size:18px;
    border-radius:10px;
    border:none;
    outline:none;
  }
  button{
    width:100%;
    padding:18px;
    font-size:22px;
    font-weight:bold;
    background:#ff5a2a;
    color:#fff;
    border:none;
    border-radius:12px;
    cursor:pointer;
  }
  button:active{ transform:scale(.98); }

  #map{
    flex:1;
    width:100%;
  }
  .msg{
    padding:10px 16px;
    font-size:16px;
    background:#0b1228;
    border-top:1px solid rgba(255,255,255,.08);
    min-height:44px;
    white-space:pre-line;
  }
  .smallbtn{
    width:auto;
    padding:12px 14px;
    font-size:16px;
    border-radius:12px;
    background:#243b6b;
  }
</style>
</head>

<body>
<div class="wrap">
  <header>Check-in HUB (com Mapa e Raio)</header>

  <div class="panel">
    <input id="driverId" placeholder="Digite seu ID" inputmode="numeric">
    <button class="smallbtn" onclick="recalibrar()">Recalibrar localização</button>
  </div>

  <div id="map"></div>

  <div class="panel">
    <button onclick="checkIn()">CHEGUEI NO HUB</button>
  </div>

  <div class="msg" id="msg">Aguardando localização...</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/*** CONFIGURE AQUI ***/
const HUB_LAT = -23.443825;     // <-- coloque a latitude real do HUB
const HUB_LNG = -46.529107;     // <-- coloque a longitude real do HUB
const RAIO_METROS = 150;        // <-- raio permitido (metros)
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyd5RFCJjpjfUd-wylkdslI9zHSx08SbuUgUViMyX4Ykwv0Jlp3UMwLeqQ72_182lvm/exec"; // <-- URL do Web App

/*** MAPA ***/
const map = L.map('map', { zoomControl:true }).setView([HUB_LAT, HUB_LNG], 17);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 20,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

// HUB marker
const hubMarker = L.marker([HUB_LAT, HUB_LNG]).addTo(map).bindPopup("HUB (ponto alvo)").openPopup();

// Raio do HUB
const hubCircle = L.circle([HUB_LAT, HUB_LNG], {
  radius: RAIO_METROS
}).addTo(map);

// Motorista marker (vai atualizar)
let driverMarker = null;
let lastPos = null;

/*** FUNÇÕES ***/
function msg(t){ document.getElementById("msg").innerText = t; }

// distância em metros (haversine)
function distanciaMetros(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = x => x*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

function atualizarMarker(lat, lng){
  lastPos = {lat, lng};

  if(!driverMarker){
    driverMarker = L.marker([lat, lng]).addTo(map).bindPopup("Você está aqui");
  }else{
    driverMarker.setLatLng([lat, lng]);
  }

  // centraliza para ver HUB + motorista (se estiver longe, ajusta)
  const group = L.featureGroup([hubMarker, driverMarker, hubCircle]);
  map.fitBounds(group.getBounds().pad(0.25));
}

function obterLocalizacao(callback){
  msg("Obtendo localização (GPS)...");

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      atualizarMarker(lat, lng);

      const d = distanciaMetros(lat, lng, HUB_LAT, HUB_LNG);
      msg(`Localização ok ✅\nDistância do HUB: ${Math.round(d)} m\nRaio permitido: ${RAIO_METROS} m`);

      callback && callback(lat, lng, d);
    },
    err => {
      msg("Não consegui acessar sua localização. Ative o GPS e permita acesso no navegador.");
    },
    { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
  );
}

function recalibrar(){
  obterLocalizacao();
}

// pega localização já no carregamento
obterLocalizacao();

/*** CHECK-IN ***/
function checkIn(){
  const id = document.getElementById("driverId").value.trim();
  if(!id){
    msg("Digite seu ID antes de enviar.");
    return;
  }

  // sempre recalcula antes de enviar
  obterLocalizacao((lat, lng, dist) => {

    if(dist > RAIO_METROS){
      msg(`Você está FORA do raio ❌\nDistância: ${Math.round(dist)} m\nAproxime do HUB e clique em Recalibrar.`);
      return;
    }

    msg("Dentro do raio ✅\nEnviando check-in...");

    fetch(WEBAPP_URL, {
      method: "POST",
      body: JSON.stringify({ id, lat, lng })
    })
    .then(r => r.text())
    .then(res => msg(res))
    .catch(() => msg("Erro ao enviar. Verifique internet e tente novamente."));
  });
}
</script>

</body>
</html>
