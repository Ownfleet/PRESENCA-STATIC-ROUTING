<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Cheguei no HUB</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  :root{
    --bg0:#070a14;
    --bg1:#0b1228;
    --card: rgba(255,255,255,.06);
    --card2: rgba(255,255,255,.08);
    --stroke: rgba(255,255,255,.10);
    --text:#e8ecff;
    --muted: rgba(232,236,255,.72);
    --brand:#ff5a2a;
    --brand2:#ff8a2a;
    --ok:#22c55e;
    --bad:#ef4444;
    --warn:#f59e0b;
    --shadow: 0 20px 60px rgba(0,0,0,.55);
    --radius: 18px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 20% -10%, rgba(255,90,42,.35), transparent 60%),
      radial-gradient(900px 500px at 110% 10%, rgba(255,138,42,.22), transparent 55%),
      radial-gradient(800px 600px at 50% 115%, rgba(99,102,241,.25), transparent 60%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    overflow:hidden;
  }

  .wrap{
    height:100vh;
    display:grid;
    grid-template-rows: auto auto 1fr auto;
  }

  header{
    padding:16px 16px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }

  .brand{
    display:flex; align-items:center; gap:12px;
  }

  .logo{
    width:44px; height:44px; border-radius:14px;
    background:
      radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.35), transparent 55%),
      linear-gradient(135deg, var(--brand), var(--brand2));
    box-shadow: 0 14px 40px rgba(255,90,42,.30);
    position:relative;
    overflow:hidden;
  }
  .logo:after{
    content:"";
    position:absolute; inset:-40%;
    background: linear-gradient(120deg, transparent, rgba(255,255,255,.25), transparent);
    transform: rotate(20deg);
    animation: shine 3.6s infinite;
  }
  @keyframes shine{
    0%{transform:translateX(-40%) rotate(20deg)}
    45%{transform:translateX(40%) rotate(20deg)}
    100%{transform:translateX(40%) rotate(20deg)}
  }

  .title{
    line-height:1.15;
  }
  .title h1{
    margin:0;
    font-size:18px;
    letter-spacing:.2px;
  }
  .title p{
    margin:3px 0 0;
    font-size:12.5px;
    color:var(--muted);
  }

  .pill{
    padding:10px 12px;
    border-radius:999px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
    display:flex;
    align-items:center;
    gap:10px;
    user-select:none;
  }

  .dot{
    width:10px;height:10px;border-radius:999px;
    background: var(--warn);
    box-shadow: 0 0 0 6px rgba(245,158,11,.12);
  }
  .pill b{font-size:12.5px}
  .pill span{font-size:12px;color:var(--muted)}

  .panel{
    padding:0 16px 12px;
    display:grid;
    grid-template-columns: 1fr auto;
    gap:12px;
    align-items:center;
  }

  .field{
    position:relative;
    background: var(--card);
    border:1px solid var(--stroke);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }

  .field:before{
    content:"";
    position:absolute; inset:0;
    background: radial-gradient(600px 120px at 30% 0%, rgba(255,90,42,.20), transparent 55%);
    pointer-events:none;
  }

  input{
    width:100%;
    padding:16px 16px 16px 46px;
    font-size:16px;
    border:0;
    outline:none;
    color:var(--text);
    background: transparent;
  }
  input::placeholder{color: rgba(232,236,255,.55)}
  .icon{
    position:absolute;
    left:14px; top:50%;
    transform:translateY(-50%);
    width:22px; height:22px;
    opacity:.9;
    color:rgba(232,236,255,.85);
  }

  .btn{
    border:0;
    border-radius: 16px;
    padding:14px 14px;
    color:var(--text);
    background: rgba(255,255,255,.07);
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: 0 14px 40px rgba(0,0,0,.35);
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:10px;
    transition: transform .12s ease, background .2s ease, border .2s ease;
    user-select:none;
  }
  .btn:hover{ background: rgba(255,255,255,.10); }
  .btn:active{ transform: scale(.98); }
  .btn .spin{
    width:16px;height:16px;border-radius:999px;
    border:2px solid rgba(255,255,255,.35);
    border-top-color: rgba(255,255,255,.95);
    display:none;
    animation: rot .8s linear infinite;
  }
  @keyframes rot{ to{ transform: rotate(360deg);} }

  .mapWrap{
    margin: 0 16px 14px;
    border-radius: 22px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.05);
    box-shadow: var(--shadow);
    position:relative;
  }

  #map{ height: 100%; min-height: 48vh; }
  @media (min-height: 780px){
    #map{ min-height: 56vh; }
  }

  .hud{
    position:absolute;
    left:12px; right:12px; top:12px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    pointer-events:none;
  }

  .badge{
    pointer-events:none;
    padding:10px 12px;
    border-radius: 14px;
    background: rgba(11,18,40,.66);
    border:1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(10px);
    box-shadow: 0 12px 30px rgba(0,0,0,.35);
    display:flex;
    gap:10px;
    align-items:center;
  }
  .badge .k{
    font-size:11.5px;
    color: rgba(232,236,255,.70);
  }
  .badge .v{
    font-size:13px;
    font-weight:800;
    letter-spacing:.2px;
  }
  .badge .miniDot{
    width:10px;height:10px;border-radius:999px;
    background: var(--warn);
    box-shadow: 0 0 0 6px rgba(245,158,11,.14);
  }

  .footer{
    padding: 0 16px 16px;
    display:grid;
    grid-template-columns: 1fr;
    gap:12px;
  }

  .cta{
    width:100%;
    padding:18px 16px;
    font-size:19px;
    font-weight:900;
    letter-spacing:.5px;
    color:white;
    border:0;
    border-radius: 20px;
    background:
      radial-gradient(120px 70px at 20% 20%, rgba(255,255,255,.25), transparent 60%),
      linear-gradient(135deg, var(--brand), var(--brand2));
    box-shadow: 0 18px 50px rgba(255,90,42,.32);
    cursor:pointer;
    transition: transform .12s ease, filter .2s ease;
    position:relative;
    overflow:hidden;
  }
  .cta:active{ transform: scale(.985); }
  .cta[disabled]{ opacity:.6; cursor:not-allowed; }
  .cta .loader{
    display:none;
    margin-left:10px;
    width:18px;height:18px;border-radius:999px;
    border:2px solid rgba(255,255,255,.35);
    border-top-color: rgba(255,255,255,1);
    animation: rot .8s linear infinite;
    vertical-align: middle;
  }

  .msg{
    padding:12px 14px;
    border-radius: 16px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    color: rgba(232,236,255,.88);
    font-size:14px;
    line-height:1.35;
    white-space:pre-line;
    box-shadow: 0 12px 30px rgba(0,0,0,.25);
  }

  /* Leaflet custom: soften */
  .leaflet-control-zoom a{
    background: rgba(11,18,40,.8) !important;
    color: #fff !important;
    border: 1px solid rgba(255,255,255,.12) !important;
    box-shadow: 0 10px 22px rgba(0,0,0,.35);
    backdrop-filter: blur(8px);
  }
  .leaflet-control-attribution{
    background: rgba(11,18,40,.6) !important;
    color: rgba(232,236,255,.75) !important;
    border-radius: 12px;
    padding: 4px 8px !important;
    border: 1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(8px);
  }
</style>
</head>

<body>
<div class="wrap">

  <header>
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <h1>Check-in HUB</h1>
        <p>GPS reforçado • Mapa • Raio de segurança</p>
      </div>
    </div>

    <div class="pill" id="statusPill">
      <div class="dot" id="statusDot"></div>
      <div>
        <b id="statusText">Calibrando...</b><br>
        <span id="statusSub">Aguardando GPS</span>
      </div>
    </div>
  </header>

  <div class="panel">
    <div class="field">
      <svg class="icon" viewBox="0 0 24 24" fill="none">
        <path d="M12 12c2.21 0 4-1.79 4-4S14.21 4 12 4 8 5.79 8 8s1.79 4 4 4Z" stroke="currentColor" stroke-width="2"/>
        <path d="M6 20c0-3.31 2.69-6 6-6s6 2.69 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <input id="driverId" placeholder="Digite seu ID" inputmode="numeric" autocomplete="off">
    </div>

    <button class="btn" onclick="recalibrar()" id="btnRecal">
      <span class="spin" id="spinRecal"></span>
      <span>Recalibrar</span>
    </button>
  </div>

  <div class="mapWrap">
    <div class="hud">
      <div class="badge">
        <div class="miniDot" id="miniDot"></div>
        <div>
          <div class="k">Situação</div>
          <div class="v" id="hudStatus">Calibrando</div>
        </div>
      </div>

      <div class="badge">
        <div>
          <div class="k">Distância do HUB</div>
          <div class="v" id="hudDist">-- m</div>
        </div>
      </div>

      <div class="badge">
        <div>
          <div class="k">Precisão do GPS</div>
          <div class="v" id="hudAcc">-- m</div>
        </div>
      </div>
    </div>

    <div id="map"></div>
  </div>

  <div class="footer">
    <button class="cta" onclick="checkIn()" id="btnSend">
      CHEGUEI NO HUB <span class="loader" id="sendLoader"></span>
    </button>

    <div class="msg" id="msg">Aguardando localização...</div>
  </div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/*** CONFIGURE AQUI ***/
const HUB_LAT = -23.443825;
const HUB_LNG = -46.529107;
const RAIO_METROS = 500;
const MIN_ACCURACY = 70;      // ✅ só envia se a precisão for <= 70m (ajuste se precisar)
const AMOSTRAS = 5;           // ✅ quantidade de leituras
const INTERVALO_MS = 700;     // ✅ intervalo entre leituras
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyd5RFCJjpjfUd-wylkdslI9zHSx08SbuUgUViMyX4Ykwv0Jlp3UMwLeqQ72_182lvm/exec";

/*** MAPA ***/
const map = L.map('map', { zoomControl:true }).setView([HUB_LAT, HUB_LNG], 17);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 20,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

const hubMarker = L.marker([HUB_LAT, HUB_LNG]).addTo(map).bindPopup("HUB (ponto alvo)");
const hubCircle = L.circle([HUB_LAT, HUB_LNG], { radius: RAIO_METROS }).addTo(map);

let driverMarker = null;
let lineToHub = null;
let lastBest = null;

/*** UI helpers ***/
const el = (id)=>document.getElementById(id);
function msg(t){ el("msg").innerText = t; }

function setStatus(type, title, sub){
  // type: "ok" | "bad" | "warn"
  const dot = el("statusDot");
  const mini = el("miniDot");

  const colors = {
    ok: ["var(--ok)", "rgba(34,197,94,.14)"],
    bad: ["var(--bad)", "rgba(239,68,68,.14)"],
    warn:["var(--warn)","rgba(245,158,11,.14)"]
  };

  const [c, glow] = colors[type] || colors.warn;
  dot.style.background = c;
  dot.style.boxShadow = `0 0 0 6px ${glow}`;
  mini.style.background = c;
  mini.style.boxShadow = `0 0 0 6px ${glow}`;

  el("statusText").innerText = title;
  el("statusSub").innerText = sub || "";
  el("hudStatus").innerText = title;
}

/*** distância (haversine) ***/
function distanciaMetros(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = x => x*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

function atualizarMapa(lat, lng){
  if(!driverMarker){
    driverMarker = L.marker([lat, lng]).addTo(map).bindPopup("Você está aqui");
  }else{
    driverMarker.setLatLng([lat, lng]);
  }

  if(lineToHub){
    map.removeLayer(lineToHub);
  }
  lineToHub = L.polyline([[lat,lng],[HUB_LAT,HUB_LNG]]).addTo(map);

  const group = L.featureGroup([hubMarker, driverMarker, hubCircle, lineToHub]);
  map.fitBounds(group.getBounds().pad(0.20));
}

function setHud(dist, acc){
  el("hudDist").innerText = `${Math.round(dist)} m`;
  el("hudAcc").innerText  = `${Math.round(acc)} m`;
}

/*** GPS reforçado: pega várias leituras e escolhe a melhor precisão ***/
function obterLocalizacaoReforcada(){
  return new Promise((resolve, reject) => {
    if(!navigator.geolocation) return reject("Geolocalização não suportada.");

    let tentativas = 0;
    let melhor = null;

    const pegar = () => {
      navigator.geolocation.getCurrentPosition(
        pos => {
          tentativas++;
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const acc = Number(pos.coords.accuracy || 9999);

          if(!melhor || acc < melhor.acc){
            melhor = { lat, lng, acc };
          }

          const distNow = distanciaMetros(lat, lng, HUB_LAT, HUB_LNG);
          const distBest = distanciaMetros(melhor.lat, melhor.lng, HUB_LAT, HUB_LNG);

          atualizarMapa(melhor.lat, melhor.lng);
          setHud(distBest, melhor.acc);

          setStatus("warn",
            "Calibrando...",
            `Leitura ${tentativas}/${AMOSTRAS} • melhor precisão ~${Math.round(melhor.acc)}m`
          );

          msg(
            `Calibrando GPS...\n`+
            `Leitura ${tentativas}/${AMOSTRAS}\n`+
            `Distância (agora): ${Math.round(distNow)}m\n`+
            `Melhor precisão: ~${Math.round(melhor.acc)}m\n`+
            `Distância (melhor): ${Math.round(distBest)}m`
          );

          if(tentativas >= AMOSTRAS){
            if(melhor.acc > MIN_ACCURACY){
              setStatus("bad","Precisão fraca", `~${Math.round(melhor.acc)}m (mín: ${MIN_ACCURACY}m)`);
              return reject(`Precisão fraca (~${Math.round(melhor.acc)}m).\nVá para um local aberto e clique em Recalibrar.`);
            }

            const dist = distanciaMetros(melhor.lat, melhor.lng, HUB_LAT, HUB_LNG);
            lastBest = { ...melhor, dist };

            if(dist <= RAIO_METROS){
              setStatus("ok","Dentro do raio", `Distância ~${Math.round(dist)}m • Raio ${RAIO_METROS}m`);
            }else{
              setStatus("bad","Fora do raio", `Distância ~${Math.round(dist)}m • Raio ${RAIO_METROS}m`);
            }

            return resolve(lastBest);
          }

          setTimeout(pegar, INTERVALO_MS);
        },
        err => reject("Ative o GPS e permita acesso à localização."),
        { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
      );
    };

    pegar();
  });
}

function toggleSpin(on){
  el("spinRecal").style.display = on ? "inline-block" : "none";
}

async function recalibrar(){
  try{
    toggleSpin(true);
    el("btnRecal").disabled = true;
    await obterLocalizacaoReforcada();
  }catch(e){
    msg(String(e));
  }finally{
    toggleSpin(false);
    el("btnRecal").disabled = false;
  }
}

/*** CHECK-IN ***/
async function checkIn(){
  const id = el("driverId").value.trim();
  if(!id){
    msg("Digite seu ID antes de enviar.");
    return;
  }

  const btn = el("btnSend");
  const loader = el("sendLoader");

  try{
    btn.disabled = true;
    loader.style.display = "inline-block";

    // sempre recalibra antes de enviar (mais confiável)
    const best = await obterLocalizacaoReforcada();

    // ✅ aqui o HTML decide, mas o SERVER vai validar de novo com tolerância
    if(best.dist > RAIO_METROS){
      setStatus("bad","Fora do raio", `Distância ~${Math.round(best.dist)}m`);
      msg(`Você está FORA do raio ❌\nDistância: ${Math.round(best.dist)}m\nRaio: ${RAIO_METROS}m\nRecalibre e aproxime do HUB.`);
      return;
    }

    setStatus("ok","Enviando...", `Distância ~${Math.round(best.dist)}m • precisão ~${Math.round(best.acc)}m`);
    msg("Dentro do raio ✅\nEnviando check-in...");

    const resp = await fetch(WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, lat: best.lat, lng: best.lng, acc: best.acc })
    });

    const txt = await resp.text();
    msg(txt);

  }catch(e){
    msg(String(e));
  }finally{
    btn.disabled = false;
    loader.style.display = "none";
  }
}

/*** iniciar ***/
recalibrar();
</script>

</body>
</html>

