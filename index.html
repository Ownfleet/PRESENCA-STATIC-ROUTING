<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Cheguei no HUB</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  :root{
    --bg0:#070a14; --bg1:#0b1228;
    --card:rgba(255,255,255,.07); --stroke:rgba(255,255,255,.12);
    --text:#e8ecff; --muted:rgba(232,236,255,.72);
    --brand:#ff5a2a; --brand2:#ff8a2a;
    --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    --r:18px; --sh:0 16px 44px rgba(0,0,0,.50);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background:
      radial-gradient(1100px 600px at 20% -10%, rgba(255,90,42,.33), transparent 60%),
      radial-gradient(900px 520px at 110% 0%, rgba(255,138,42,.22), transparent 58%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    overflow:hidden;
  }

  .app{
    height:100vh;
    display:grid;
    grid-template-rows:auto auto auto 1fr;
    gap:10px;
    padding: env(safe-area-inset-top) 12px env(safe-area-inset-bottom) 12px;
  }

  header{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:10px 4px 0;
  }
  .brand{display:flex; gap:10px; align-items:center;}
  .logo{
    width:44px;height:44px;border-radius:14px;
    background:linear-gradient(135deg,var(--brand),var(--brand2));
    box-shadow:0 14px 38px rgba(255,90,42,.28);
  }
  .ttl h1{margin:0;font-size:16px;font-weight:950}
  .ttl p{margin:3px 0 0;font-size:12px;color:var(--muted)}

  .status{
    display:flex; align-items:center; gap:8px;
    padding:10px 12px; border-radius:999px;
    background:rgba(255,255,255,.06);
    border:1px solid var(--stroke);
    box-shadow:0 10px 26px rgba(0,0,0,.22);
    min-width:150px; justify-content:center;
  }
  .dot{width:10px;height:10px;border-radius:99px;background:var(--warn);box-shadow:0 0 0 6px rgba(245,158,11,.14);}
  .stxt{font-size:12.5px;font-weight:950}
  .smini{font-size:11px;color:var(--muted)}

  .card{
    background:var(--card);
    border:1px solid var(--stroke);
    border-radius:var(--r);
    box-shadow:var(--sh);
    overflow:hidden;
  }

  .row{
    padding:10px;
    display:grid;
    grid-template-columns:1fr auto;
    gap:10px;
    align-items:center;
  }

  input{
    width:100%;
    padding:14px 14px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.06);
    border-radius:16px;
    color:var(--text);
    font-size:16px;
    outline:none;
  }
  input::placeholder{color:rgba(232,236,255,.55)}

  .btn{
    border:0;
    border-radius:16px;
    padding:12px 12px;
    color:var(--text);
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.12);
    cursor:pointer;
    white-space:nowrap;
  }
  .btn:active{transform:scale(.985)}
  .btn[disabled]{opacity:.6; cursor:not-allowed;}

  .infoGrid{
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:8px;
    padding:10px;
  }
  .info{
    padding:10px;
    border-radius:16px;
    background:rgba(11,18,40,.55);
    border:1px solid rgba(255,255,255,.10);
  }
  .k{font-size:11px;color:var(--muted)}
  .v{margin-top:2px;font-size:13px;font-weight:950}

  @media(max-width:360px){
    .infoGrid{grid-template-columns:1fr 1fr;}
    .status{min-width:120px}
  }

  /* MAPA MENOR */
  .mapWrap{height:28vh; min-height:190px;}
  #map{height:100%; width:100%;}

  .footer{
    display:grid;
    grid-template-rows:auto 1fr;
    gap:10px;
  }

  .cta{
    width:100%;
    padding:16px 14px;
    font-size:18px;
    font-weight:950;
    border:0;
    border-radius:20px;
    color:#fff;
    background:linear-gradient(135deg,var(--brand),var(--brand2));
    box-shadow:0 18px 44px rgba(255,90,42,.28);
    cursor:pointer;
  }
  .cta:active{transform:scale(.985)}
  .cta[disabled]{opacity:.6; cursor:not-allowed;}
  .loader{
    width:18px;height:18px;border-radius:99px;
    border:2px solid rgba(255,255,255,.35);
    border-top-color:#fff;
    display:inline-block;
    margin-left:10px;
    vertical-align:middle;
    animation:rot .8s linear infinite;
  }
  @keyframes rot{to{transform:rotate(360deg)}}

  .msg{
    padding:12px;
    border-radius:var(--r);
    background:rgba(0,0,0,.30);
    border:1px solid rgba(255,255,255,.10);
    font-size:13.5px;
    line-height:1.35;
    white-space:pre-wrap;
    overflow:auto;
  }

  .leaflet-control-zoom a{background:rgba(11,18,40,.82)!important;color:#fff!important;border:1px solid rgba(255,255,255,.12)!important;}
  .leaflet-control-attribution{background:rgba(11,18,40,.62)!important;color:rgba(232,236,255,.75)!important;border-radius:12px;padding:4px 8px!important;border:1px solid rgba(255,255,255,.10);}

</style>
</head>
<body>

<div class="app">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div class="ttl">
        <h1>Cheguei no HUB</h1>
        <p>Sem erro de envio (sem CORS)</p>
      </div>
    </div>
    <div class="status">
      <span class="dot" id="dot"></span>
      <div>
        <div class="stxt" id="stxt">Calibrando…</div>
        <div class="smini" id="smini">Aguardando GPS</div>
      </div>
    </div>
  </header>

  <div class="card">
    <div class="row">
      <input id="driverId" placeholder="Digite seu ID" inputmode="numeric" autocomplete="off">
      <button class="btn" id="btnRecal" onclick="recalibrar()">Recalibrar</button>
    </div>

    <div class="infoGrid">
      <div class="info"><div class="k">Distância</div><div class="v" id="dist">-- m</div></div>
      <div class="info"><div class="k">Raio</div><div class="v" id="raio">-- m</div></div>
      <div class="info"><div class="k">Precisão</div><div class="v" id="acc">-- m</div></div>
    </div>
  </div>

  <div class="card mapWrap">
    <div id="map"></div>
  </div>

  <div class="footer">
    <button class="cta" id="btnSend" onclick="checkIn()">CHEGUEI NO HUB<span id="ld" style="display:none" class="loader"></span></button>
    <div class="msg" id="msg">Aguardando localização...</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/*** MESMAS CONFIGS DO SERVIDOR ***/
const HUB_LAT = -23.443825;
const HUB_LNG = -46.529107;
const RAIO_METROS = 500;

const MIN_ACCURACY = 120;
const AMOSTRAS = 5;
const INTERVALO_MS = 650;

const el = id => document.getElementById(id);
function msg(t){ el("msg").textContent = t; }

function setStatus(type, title, sub){
  const dot = el("dot");
  const map = {
    ok: ["#22c55e","rgba(34,197,94,.14)"],
    bad:["#ef4444","rgba(239,68,68,.14)"],
    warn:["#f59e0b","rgba(245,158,11,.14)"]
  };
  const [c, glow] = map[type] || map.warn;
  dot.style.background = c;
  dot.style.boxShadow = `0 0 0 6px ${glow}`;
  el("stxt").innerText = title;
  el("smini").innerText = sub || "";
}

el("raio").innerText = `${RAIO_METROS} m`;

function distanciaMetros(lat1, lon1, lat2, lon2){
  const R = 6371000, toRad = x => x*Math.PI/180;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R * (2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

/*** MAPA ***/
const map = L.map('map').setView([HUB_LAT, HUB_LNG], 17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20, attribution: '&copy; OpenStreetMap' }).addTo(map);
const hubMarker = L.marker([HUB_LAT, HUB_LNG]).addTo(map).bindPopup("HUB");
const hubCircle = L.circle([HUB_LAT, HUB_LNG], { radius: RAIO_METROS }).addTo(map);

let driverMarker=null, lineToHub=null, lastBest=null;

function updateMap(lat,lng){
  if(!driverMarker) driverMarker = L.marker([lat,lng]).addTo(map).bindPopup("Você");
  else driverMarker.setLatLng([lat,lng]);
  if(lineToHub) map.removeLayer(lineToHub);
  lineToHub = L.polyline([[lat,lng],[HUB_LAT,HUB_LNG]]).addTo(map);

  const group = L.featureGroup([hubMarker, hubCircle, driverMarker]);
  map.fitBounds(group.getBounds().pad(0.20));
}

function obterLocalizacaoReforcada(){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject("Sem suporte a GPS.");
    let tent=0, best=null;

    const step=()=>{
      navigator.geolocation.getCurrentPosition(pos=>{
        tent++;
        const lat=pos.coords.latitude, lng=pos.coords.longitude;
        const acc=Number(pos.coords.accuracy||9999);
        if(!best || acc<best.acc) best={lat,lng,acc};

        const dist=distanciaMetros(best.lat,best.lng,HUB_LAT,HUB_LNG);
        lastBest={...best,dist};

        el("dist").innerText = `${Math.round(dist)} m`;
        el("acc").innerText  = `${Math.round(best.acc)} m`;
        updateMap(best.lat,best.lng);

        setStatus("warn","Calibrando…",`leitura ${tent}/${AMOSTRAS} • ~${Math.round(best.acc)}m`);
        msg(`GPS leitura ${tent}/${AMOSTRAS}\nPrecisão: ~${Math.round(best.acc)}m\nDistância: ${Math.round(dist)}m`);

        if(tent>=AMOSTRAS){
          if(best.acc>MIN_ACCURACY){
            setStatus("bad","Precisão fraca",`~${Math.round(best.acc)}m`);
            return reject(`Precisão fraca (~${Math.round(best.acc)}m). Recalibre em local aberto.`);
          }
          if(dist<=RAIO_METROS) setStatus("ok","Dentro do raio",`dist ~${Math.round(dist)}m`);
          else setStatus("bad","Fora do raio",`dist ~${Math.round(dist)}m`);
          return resolve(lastBest);
        }
        setTimeout(step, INTERVALO_MS);
      }, _=>reject("Permita o GPS e ative alta precisão."),
      {enableHighAccuracy:true, timeout:15000, maximumAge:0});
    };
    step();
  });
}

async function recalibrar(){
  try{
    el("btnRecal").disabled=true;
    await obterLocalizacaoReforcada();
  }catch(e){
    msg(String(e));
  }finally{
    el("btnRecal").disabled=false;
  }
}

/*** ENVIO SEM FETCH: google.script.run (SEM CORS) ***/
async function checkIn(){
  const id = el("driverId").value.trim();
  if(!id){ msg("Digite seu ID antes de enviar."); return; }

  const btn = el("btnSend");
  const ld  = el("ld");
  btn.disabled=true; ld.style.display="inline-block";

  try{
    const best = await obterLocalizacaoReforcada();
    if(best.dist > RAIO_METROS){
      msg(`Fora do raio ❌\nDistância: ${Math.round(best.dist)}m\nRaio: ${RAIO_METROS}m`);
      return;
    }

    msg("Dentro do raio ✅\nEnviando...");

    google.script.run
      .withSuccessHandler(res=>{
        msg(res);
        btn.disabled=false; ld.style.display="none";
      })
      .withFailureHandler(err=>{
        msg("Erro ao enviar: " + (err && err.message ? err.message : err));
        btn.disabled=false; ld.style.display="none";
      })
      .registrarChegada({ id, lat: best.lat, lng: best.lng, acc: best.acc });

  }catch(e){
    msg("Erro: " + e);
    btn.disabled=false; ld.style.display="none";
  }
}

recalibrar();
</script>
</body>
</html>
